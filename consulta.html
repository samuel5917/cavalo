<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Intelligence | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: #0f172a; border: 1px solid #1e293b; }
        input { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; }
        input:focus { border-color: #3b82f6 !important; outline: none; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <nav class="fixed top-6 left-1/2 -translate-x-1/2 z-50 flex gap-4 p-2 glass rounded-2xl shadow-2xl">
        <a href="index.html" class="px-4 py-2 hover:bg-slate-800 rounded-xl text-xs font-bold uppercase tracking-widest text-slate-400 transition-all">Registrar</a>
        <a href="consulta.html" class="px-4 py-2 bg-blue-600 rounded-xl text-xs font-bold uppercase tracking-widest text-white">Consultar/Excel</a>
    </nav>

    <div class="max-w-7xl mx-auto space-y-6 mt-16">
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 glass p-6 rounded-3xl">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-emerald-600 rounded-2xl">
                    <i data-lucide="bar-chart-3" class="text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight uppercase">Dashboard de Remanejo</h1>
                    <p class="text-slate-500 text-[10px] font-mono tracking-widest">Acesso Direto: Supabase Cloud</p>
                </div>
            </div>
            <button onclick="exportarExcel()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-2xl font-bold flex items-center gap-3 transition-all shadow-lg active:scale-95">
                <i data-lucide="file-down"></i> BAIXAR EXCEL FORMATADO
            </button>
        </header>

        <div class="glass p-6 rounded-3xl grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <input type="text" id="f_tag" oninput="filtrar()" placeholder="Filtrar TAG CB..." class="p-3 rounded-xl text-sm">
            <input type="text" id="f_mat" oninput="filtrar()" placeholder="Filtrar Material..." class="p-3 rounded-xl text-sm">
            <input type="text" id="f_data" oninput="filtrar()" placeholder="Filtrar Data (DD/MM/AAAA)..." class="p-3 rounded-xl text-sm">
            <input type="text" id="f_hora" oninput="filtrar()" placeholder="Filtrar Horário..." class="p-3 rounded-xl text-sm">
        </div>

        <div class="glass rounded-3xl overflow-hidden shadow-2xl">
            <div class="table-container overflow-x-auto">
                <table class="w-full text-left text-sm border-collapse">
                    <thead class="bg-slate-900/80 text-slate-500 border-b border-slate-800">
                        <tr>
                            <th class="p-5 font-bold uppercase text-[10px]">TAG CB</th>
                            <th class="p-5 font-bold uppercase text-[10px]">Material</th>
                            <th class="p-5 font-bold uppercase text-[10px]">Origem</th>
                            <th class="p-5 font-bold uppercase text-[10px]">Destino</th>
                            <th class="p-5 font-bold uppercase text-[10px]">Peso</th>
                            <th class="p-5 font-bold uppercase text-[10px]">Turno</th>
                            <th class="p-5 font-bold uppercase text-[10px]">Data</th>
                            <th class="p-5 font-bold uppercase text-[10px]">Horário</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCorpo" class="divide-y divide-slate-800/50">
                        </tbody>
                </table>
            </div>
            <div id="loader" class="p-20 text-center flex flex-col items-center gap-3">
                <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-slate-500 font-mono text-xs">BUSCANDO_DADOS_SUPABASE...</p>
            </div>
        </div>
    </div>

    <script>
        // Credenciais
        const SUPABASE_URL = 'https://lkbyphypfmouahxpzhst.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_N9X2k--CcuTcdNFUDU0K8w_wEKZaJvV';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let dadosOriginais = [];
        let dadosExibidos = [];

        async function carregarDados() {
            const { data, error } = await _supabase
                .from('movimentacoes')
                .select('*')
                .order('id', { ascending: false });

            if (error) {
                alert("Erro ao carregar: " + error.message);
                return;
            }

            dadosOriginais = data;
            dadosExibidos = data;
            document.getElementById('loader').classList.add('hidden');
            renderizar(dadosExibidos);
        }

        function renderizar(lista) {
            const corpo = document.getElementById('tabelaCorpo');
            corpo.innerHTML = lista.map(item => `
                <tr class="hover:bg-blue-600/5 transition-colors">
                    <td class="p-5 font-mono text-blue-400 font-bold">${item.tag_cb || '-'}</td>
                    <td class="p-5 font-semibold">${item.material || '-'}</td>
                    <td class="p-5 text-slate-400">${item.origem || '-'}</td>
                    <td class="p-5 text-slate-400">${item.destino || '-'}</td>
                    <td class="p-5 font-bold text-emerald-400">${parseFloat(item.peso || 0).toFixed(3)}</td>
                    <td class="p-5 text-xs text-slate-300 uppercase">${item.turno || '-'}</td>
                    <td class="p-5 text-slate-400">${item.data || '-'}</td>
                    <td class="p-5 text-slate-500 font-mono text-[11px]">${item.horario || '-'}</td>
                </tr>
            `).join('');
            try { lucide.createIcons(); } catch(e) {}
        }

        function filtrar() {
            const fTag = document.getElementById('f_tag').value.toLowerCase();
            const fMat = document.getElementById('f_mat').value.toLowerCase();
            const fData = document.getElementById('f_data').value.toLowerCase();
            const fHora = document.getElementById('f_hora').value.toLowerCase();

            dadosExibidos = dadosOriginais.filter(i => 
                String(i.tag_cb).toLowerCase().includes(fTag) &&
                String(i.material).toLowerCase().includes(fMat) &&
                String(i.data).toLowerCase().includes(fData) &&
                String(i.horario).toLowerCase().includes(fHora)
            );
            renderizar(dadosExibidos);
        }

        async function exportarExcel() {
            const workbook = new ExcelJS.Workbook();
            const ws = workbook.addWorksheet('MOVIMENTAÇÕES');

            // 1. Título Azul Royal (Conforme sua planilha do Excel)
            ws.mergeCells('A1:H1');
            const title = ws.getCell('A1');
            title.value = 'MOVIMENTAÇÕES REMANEJO DE PRODUTOS';
            title.font = { name: 'Arial', bold: true, size: 14, color: { argb: 'FFFFFFFF' } };
            title.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0070C0' } };
            title.alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getRow(1).height = 25;

            // 2. Cabeçalho das Colunas
            const headerRow = ws.addRow(['TAG CB', 'MATERIAL', 'ORIGEM', 'DESTINO', 'PESO', 'TURNO', 'DATA', 'HORÁRIO']);
            headerRow.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9E1F2' } };
                cell.font = { bold: true };
                cell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
                cell.alignment = { horizontal: 'center' };
            });

            // 3. Dados Formatados (Azul Claro)
            dadosExibidos.forEach(item => {
                const row = ws.addRow([item.tag_cb, item.material, item.origem, item.destino, item.peso, item.turno, item.data, item.horario]);
                row.eachCell(cell => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEBF1DE' } }; // Verde/Azul claro padrão Excel
                    cell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
                });
            });

            ws.columns.forEach(c => c.width = 15);

            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), `Relatorio_Remanejo.xlsx`);
        }

        carregarDados();
    </script>
</body>
</html>
